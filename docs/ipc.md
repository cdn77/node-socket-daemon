# Nodesockd IPC protocol

Nodesockd uses ZeroMQ for all interprocess communication. The Nodesockd
daemon binds a _router_ socket and all other processes that want to communicate
with it connect to that socket using a _dealer_ socket.

## Common

### Peer types and identification

There are three known peer types: the daemon, worker processes and the client
library. Clients wishing to communicate with the daemon must identify themselves
using the ZeroMQ connection identifier. Workers are identified by the prefix
`w:`, followed by the worker ID (4 hex characters). The client library, and by
extension the CLI commands, are identified by the prefix `c:`, followed by
the PID.


### Messages

All messages are JSON-encoded objects whose structure must extend the following
interface:

```typescript
interface IpcMessage {
  type: string;
  data?: JsonObject;
}
```


### Requests, replies and reply streams

Messages which request any kind of reply from the other peer must conform
to the following interface:

```typescript
interface IpcRequest extends IpcMessage {
  id: string;
}
```

The request `id` is a unique ID generated by the requesting peer. Replies to
requests must conform to the following interface:

```typescript
interface IpcReply extends IpcMessage {
  type: 'reply';
  requestId: string;
  errors?: string[];
  done?: boolean;
}
```

The `requestId` must be the set to the value of the `id` property of
the `IpcRequest` which the reply belongs to.

The `done` property can be used to signal to the requester that multiple replies
should be expected; the requester should only consider its request to be entirely
fulfilled once it receives an `IpcReply` with the `done` property set to `true`.
This way, peers can send asynchronous _reply streams_ when needed, instead of
single replies.


## Message types

The three peer types each have a map of message and request types which they
can send, and message and request types which they're able to receive.
These maps are defined near the bottom of the following files:
 - `src/daemon/types.ts` for messages and requests the daemon can send / receive,
 - `src/worker/types.ts` for messages and requests workers can send / receive, and
 - `src/client/types.ts` for messages and requests clients can send / receive
